<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VData Avalanches</title>
    <style>
        svg {
            background-color: rgb(252, 252, 252);
            margin : 0 auto;}
    </style>
    <style>
    div.tooltip {
        position: absolute;
        text-align: center;
        padding: .2rem;
        background: #313639;
        color: #f9f9f9;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        font-size: .7rem;
   }</style>
    
</head>
<body>
    <script src = "https://cdn.jsdelivr.net/npm/d3@7.3.0/dist/d3.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/7.4.4/d3.min.js'></script>
    <h1>Nombre de morts par avalanches dans le canton du Valais entre 1995 et 2021</h1>
    
    <script>
    'use strict'
        const hauteur = window.innerHeight;
        const largeur = window.innerWidth;

        d3.csv("AvalancheAccidentsSwitzerlandSince1995.csv", function(d){
            return{
                id : d.avalancheId,
                date : d.date,
                annéeHydrologique : d.hydrologicalYear,
                lieuDit : d.localName,
                Canton : d.canton,
                nombreDeMorts : d.numberDead,
                activité : d.activity,
            }})
        .then(myData =>{

            let totalMorts = d3.sum(myData, d => d.nombreDeMorts)
            console.log("Total des morts par avalanches en Suisse depuis 1995/96 :", totalMorts);
            
            //VS
            let avalanchesVS = d3.filter(myData, d => d.Canton == 'VS')
            console.log("Avalanches dans le canton du Valais", avalanchesVS);
            let avalanchesVSAnnee = d3.groups(avalanchesVS, d => d.annéeHydrologique)
            console.log("Avalanches en Valais par année", avalanchesVSAnnee);
            let mortsVS = d3.sum(avalanchesVS, d => d.nombreDeMorts)
            console.log("Morts dans le canton du Valais", mortsVS);
            let mortsVSAnnee = d3.rollups(avalanchesVS, v => d3.sum(v,d => d.nombreDeMorts), d => d.annéeHydrologique)
            console.log("Morts en Valais par année :", mortsVSAnnee);

            //Mise en place du canevas
            const canevas1 = d3.select("body")
                    .append ("svg")
                    .attr("width", largeur)
                    .attr("height", hauteur);   

            //Echelle des x
            const xScale = d3.scaleBand()
                .domain(avalanchesVS.map(d => d.annéeHydrologique))
                .range([10,1000]);
            console.log("Test échelle x", xScale("1995/96"))

            //Création de l'axe X
            canevas1.append('g')
                .classed('axeX', true)
                .attr("transform", 'translate(50,500)')
                .call(d3.axisBottom(xScale).ticks(26))
                .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(-45)")
                    .style("text-anchor", "end")

            //Echelle des y
            const yScale = d3.scaleLinear()
                .domain([0,d3.max(  mortsVSAnnee.map((value,index) => value[1]))])
                .range([400, 0])
            console.log("Test échelle y", yScale(15));

            //Création de l'axe Y
            canevas1.append("g")
                .classed('axeY', true)
                .attr("transform", 'translate(60,100)')
                .call(d3.axisLeft(yScale).ticks(20))
            
            
            // Ajout des lignes
            canevas1.append("path").datum(mortsVSAnnee)
                .attr("fill", "none")
                .attr("stroke", "lightblue")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(d => 67 + xScale(d[0]))
                    .y(d => yScale(d[1] -5)))
          
            var div = d3.select("canevas1").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Ajout des points
            canevas1.append("g").selectAll("dot")
            .data(mortsVSAnnee)
            .join("circle")
                .attr("cx", d => 67 + xScale(d[0]))
                .attr("cy", function (d) {return yScale(d[1] -5)})
                .attr("r", 5)
                .attr("fill", "steelblue")
                .on('mouseover', function (d, i) {
                    d3.select(this).transition()
                        .duration('100')
                        .attr("r", 7); 
                    div.transition()
                        .duration(100)
                        .style("opacity", 1);
                    })
                .on('mouseout', function (d, i) {
                    d3.select(this).transition()
                        .duration('200')
                        .attr("r", 5);
                    div.transition()
                        .duration('200')
                        .style("opacity", 0);
                });
        })
    </script>

</body>
</html>
